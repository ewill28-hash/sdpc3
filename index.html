<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SongdoPickleball (supr)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pickle: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            900: '#064e3b',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Firebase App (Compat) & Services -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>


    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
	//SDPC-L3+k1.1(224)  -오전 9:17 2026-02-25

        // --- Configuration & Constants ---
        const INITIAL_RATING = 3.000;
        const K_FACTOR = 0.11;
        let SDS_HISTORY_DEL_ONE = "0.12";
        let SDS_MEMBER_TAB = "0.13";
        let SDS_ADMIN = "0.14";
        let SDS_MEMBER_DEL_ONE = "0.15";
        const ITEMS_PER_PAGE = 20;
        const MIN_PARTNER_MATCHES = 5; 
        const { useState, useEffect, useRef } = React;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1pj4uw9LyUUTtWn_a28ABN0BC-0zkynY",
            authDomain: "tele-486906.firebaseapp.com",
            projectId: "tele-486906",
            storageBucket: "tele-486906.firebasestorage.app",
            messagingSenderId: "780009385301",
            appId: "1:780009385301:web:4163b27573a0b5e72e13dc"
        };
        const appId = "c_ac4b11f21466d242_todo_app.html-379";

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Helper Functions ---
        const formatDate = (ts) => {
            if (!ts) return '-';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
        };

        const calculateRatingChange = (myAvg, oppAvg, myScore, oppScore) => {
            const diff = oppAvg - myAvg;
            const sensitivity = 1.3; 
            const expected = 1 / (1 + Math.pow(10, diff * sensitivity));
            const totalPoints = myScore + oppScore;
            const pointShare = totalPoints === 0 ? 0.5 : myScore / totalPoints;
            let winStatus = 0.5;
            if (myScore > oppScore) winStatus = 1.0;
            else if (myScore < oppScore) winStatus = 0.0;
            const performance = (0.2 * winStatus) + (0.8 * pointShare);
            return K_FACTOR * (performance - expected);
        };

        // 소수 첫째자리 구간별 배경색 지정 (0.2 단위) - 목록용
        const getRatingBgClass = (rating) => {
            // 4.0 이상: 회색 (거의 불투명하게 설정하여 깔끔함 강조)
            if (rating >= 4.0) return "bg-gray/90 hover:bg-gray"; 
            // 3.8 이상: 장미색 (뚜렷한 핑크레드)
            if (rating >= 3.8) return "bg-rose-100/90 hover:bg-rose-200";
            // 3.6 이상: 파란색 (맑고 진한 하늘색)
            if (rating >= 3.6) return "bg-sky-100/90 hover:bg-sky-200";
            // 3.4 이상: 호박색 (확실한 노랑/주황)
            if (rating >= 3.4) return "bg-orange-100/90 hover:bg-orange-200";
            // 3.2 이상: 에메랄드색 (안정적인 녹색)
            if (rating >= 3.2) return "bg-emerald-100/90 hover:bg-emerald-200";
            // 3.0 이상: 보라색 (선명해진 보라)
            if (rating >= 3.0) return "bg-purple-100/90 hover:bg-purple-200";
            // 기본값: 회색 (조금 더 진한 회색으로 변경)
            return "bg-gray-100 hover:bg-gray-200";
        };

        // 소수 첫째자리 구간별 색상 지정 - 분포도 막대용
        const getBarColorClass = (ratingStr) => {
            const r = parseFloat(ratingStr);
            if (r >= 4.0) return "bg-gray-400";            
            if (r >= 3.8) return "bg-rose-400";
            if (r >= 3.6) return "bg-sky-400";
            if (r >= 3.4) return "bg-orange-400";
            if (r >= 3.2) return "bg-emerald-400";
            if (r >= 3.0) return "bg-purple-400";
            if (r >= 2.0) return "bg-slate-400";
            return "bg-gray-400";
        };

        // --- UI Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        attrs: {
                            class: className,
                            style: `width: ${size}px; height: ${size}px;`
                        }
                    });
                }
            }, [name, className, size]);

            return (
                <span ref={iconRef} className="inline-flex items-center justify-center">
                    <i data-lucide={name}></i>
                </span>
            );
        };

        const Toast = ({ message, onClose }) => {
            React.useEffect(() => {
                if (message) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [message, onClose]);
            if (!message) return null;
            return (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 animate-bounce">
                    <Icon name="check-circle" size={18} className="text-emerald-400" />
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const Modal = ({ isOpen, title, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50 p-4" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 relative flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 shrink-0">
                            <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icon name="user" size={18} /> {title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="overflow-y-auto hide-scrollbar flex-1 pb-2">{children}</div>
                    </div>
                </div>
            );
        };

        const PasswordCheck = ({ isOpen, onClose, onSuccess, requiredPwd, title = "인증" }) => {
            const [input, setInput] = React.useState("");
            const handleSubmit = () => {
                if (input === requiredPwd) {
                    setInput("");
                    onSuccess();
                    onClose();
                } else {
                    alert("비밀번호가 일치하지 않습니다.");
                    setInput("");
                }
            };
            return (
                <Modal isOpen={isOpen} title={title} onClose={onClose}>
                    <input 
                        type="password" 
                        inputMode="numeric"
                        className="w-full border border-gray-300 rounded-lg p-3 text-center text-xl tracking-widest mb-4 focus:ring-2 focus:ring-pickle-500 outline-none"
                        placeholder="******"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                        autoFocus
                    />
                    <button onClick={handleSubmit} className="w-full bg-pickle-600 text-white py-3 rounded-lg font-bold shadow hover:bg-pickle-700 transition">확인</button>
                </Modal>
            );
        };

        // --- Rating Graph Component ---
        const RatingGraph = ({ member, matches }) => {
            const history = React.useMemo(() => {
                const filtered = matches
                    .filter(m => [...(m.teamA || []), ...(m.teamB || [])].some(p => p.id === member.id))
                    .sort((a, b) => {
                        const seqA = typeof a.matchSeq === 'number' ? a.matchSeq : 0;
                        const seqB = typeof b.matchSeq === 'number' ? b.matchSeq : 0;
                        if (seqA !== seqB) return seqA - seqB;
                        const timeA = a.createdAt?.toMillis() || 0;
                        const timeB = b.createdAt?.toMillis() || 0;
                        if (timeA !== timeB) return timeA - timeB;
                        return a.id.localeCompare(b.id);
                    })
                    .slice(-20);

                const ratings = filtered.map(m => {
                    const p = [...(m.teamA || []), ...(m.teamB || [])].find(player => player.id === member.id);
                    return p?.afterRating || INITIAL_RATING;
                });

                return ratings.length > 0 ? ratings : [member.rating || INITIAL_RATING];
            }, [member, matches]);

            if (history.length < 2) {
                return <div className="p-10 text-center text-gray-400 text-sm">기록이 더 쌓이면 그래프가 표시됩니다.</div>;
            }

            const currentMax = Math.max(...history);
            const currentMin = Math.min(...history);
            const currentFinal = history[history.length - 1];

            const min = Math.min(...history) - 0.05;
            const max = Math.max(...history) + 0.05;
            const range = max - min;
            
            const width = 300;
            const height = 150;
            const padding = 20;

            const points = history.map((r, i) => {
                const x = padding + (i * (width - padding * 2) / (history.length - 1));
                const y = height - (padding + ((r - min) / range) * (height - padding * 2));
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full space-y-4">
                    <div className="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto drop-shadow-sm">
                            <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#e5e7eb" strokeWidth="1" />
                            <polyline
                                fill="none"
                                stroke="#10b981"
                                strokeWidth="3"
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                points={points}
                            />
                            {history.map((r, i) => {
                                const [x, y] = points.split(' ')[i].split(',');
                                return (
                                    <circle key={i} cx={x} cy={y} r="3" fill="white" stroke="#10b981" strokeWidth="2" />
                                );
                            })}
                        </svg>
                        <div className="flex justify-between mt-2 text-[10px] text-gray-400 font-bold px-1">
                            <span>최근 경기 추이</span>
                            <div className="flex flex-col items-center py-2 bg-white rounded-lg border border-gray-100">
                                <span className="text-[8px] text-gray-400 font-bold uppercase">Min</span>
                                <span className="text-[11px] font-black text-rose-500">{currentMin.toFixed(3)}</span>
                            </div>
                            <div className="flex flex-col items-center py-2 bg-white rounded-lg border border-gray-100">
                                <span className="text-[8px] text-gray-400 font-bold uppercase">Max</span>
                                <span className="text-[11px] font-black text-emerald-600">{currentMax.toFixed(3)}</span>
                            </div>
                            <div className="flex flex-col items-center py-2 bg-emerald-500 rounded-lg">
                                <span className="text-[8px] text-white/70 font-bold uppercase">Final</span>
                                <span className="text-[11px] font-black text-white">{currentFinal.toFixed(3)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [db, setDb] = useState(null);
            const [tab, setTab] = React.useState('match');
            const [members, setMembers] = React.useState([]);
            const [matches, setMatches] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [toast, setToast] = React.useState(null);
            const [pwdModal, setPwdModal] = React.useState({ isOpen: false, reqPwd: '', onSuccess: () => {}, title: '' });
            const [detailMember, setDetailMember] = React.useState(null);
            const [showDistModal, setShowDistModal] = React.useState(false); // 분포도 모달 상태
            const [showPartnerModal, setShowPartnerModal] = React.useState(false); // 파트너 통계 모달

            const [teamA, setTeamA] = React.useState([]);
            const [teamB, setTeamB] = React.useState([]);
            const [scoreA, setScoreA] = React.useState(11);
            const [scoreB, setScoreB] = React.useState(11);
            const [newMemberText, setNewMemberText] = React.useState("");
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [adminPwdInput, setAdminPwdInput] = React.useState("");
            const [historyFilter, setHistoryFilter] = React.useState('today');
            const [nameSearch, setNameSearch] = React.useState('');
            const [currentPage, setCurrentPage] = React.useState(1);
            
            const [showBulkUpload, setShowBulkUpload] = React.useState(false);
            const [bulkText, setBulkText] = React.useState("");
            const [adminSort, setAdminSort] = React.useState('name');

            // Initialize Firebase inside Babel script
            useEffect(() => {
                const init = async () => {
                    try {
                        // Firebase 앱 초기화 (Compat 버전은 전역 firebase 객체 사용)
                        let app;
                        if (!firebase.apps.length) {
                            app = firebase.initializeApp(firebaseConfig);
                        } else {
                            app = firebase.app();
                        }

                        const auth = app.auth();
                        const firestore = app.firestore();
                        setDb(firestore);

                        // Auth Logic
                        const handleAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                try {
                                    await auth.signInWithCustomToken(__initial_auth_token);
                                } catch (e) {
                                    await auth.signInAnonymously();
                                }
                            } else {
                                await auth.signInAnonymously();
                            }
                        };

                        await handleAuth();
                        auth.onAuthStateChanged(u => setUser(u));
                    } catch (err) {
                        console.error("Firebase Init Error:", err);
                    }
                };
                init();
            }, []);


            React.useEffect(() => {
                if (!user) return;
                const memberPath = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members');
                const matchPath = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches');

//////////////////////
            const matchRef = db.collection('artifacts').doc(appId)
                            .collection('public').doc('data')
                            .collection('games').doc('maxgame2'); 
            matchRef.get().then((doc) => {
                if (doc.exists) {
                    return SDS_MEMBER_TAB = doc.data().value4;
                    }
                });
            matchRef.get().then((doc) => {
                if (doc.exists) {
                    return SDS_ADMIN = doc.data().value4;
                    }
                });
            matchRef.get().then((doc) => {
                if (doc.exists) {
                    return SDS_MEMBER_DEL_ONE = doc.data().value4;
                    }
                });
            matchRef.get().then((doc) => {
                if (doc.exists) {
                    return SDS_HISTORY_DEL_ONE = doc.data().value4;
                    }
                });
//////////////////////

                const unsubMembers = memberPath.onSnapshot(snap => {
                    const list = [];
                    snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    list.sort((a, b) => a.name.localeCompare(b.name));
                    setMembers(list);
                });

                const unsubMatches = matchPath.onSnapshot(snap => {
                    const list = [];
                    snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    list.sort((a, b) => {
                        const seqA = typeof a.matchSeq === 'number' ? a.matchSeq : 0;
                        const seqB = typeof b.matchSeq === 'number' ? b.matchSeq : 0;
                        if (seqA !== seqB) return seqB - seqA;
                        
                        const timeA = a.createdAt?.toMillis() || 0;
                        const timeB = b.createdAt?.toMillis() || 0;
                        if (timeA !== timeB) return timeB - timeA;
                        
                        return b.id.localeCompare(a.id);
                    });
                    setMatches(list);
                    setLoading(false);
                }, (error) => console.error("Matches listen error:", error));

                return () => { unsubMembers(); unsubMatches(); };
            }, [user]);

            React.useEffect(() => {
                setCurrentPage(1);
            }, [historyFilter, nameSearch]);

            const showToast = (msg) => setToast(msg);
            const openPwd = (req, title, cb) => setPwdModal({ isOpen: true, reqPwd: req, title, onSuccess: cb });

            const getMaxSeq = () => {
                if (matches.length === 0) return 0;
                const max = Math.max(...matches.map(m => typeof m.matchSeq === 'number' ? m.matchSeq : 0));
                return max > 0 ? max : matches.length;
            };

            const getMemberStats = (memberId) => {
                let wins = 0, total = 0, totalPoints = 0;
                matches.forEach(m => {
                    const isPlayerA = m.teamA?.some(p => p.id === memberId);
                    const isPlayerB = m.teamB?.some(p => p.id === memberId);
                    if (isPlayerA || isPlayerB) {
                        total++;
                        if (isPlayerA) {
                            totalPoints += (m.scoreA || 0);
                            if (m.scoreA > m.scoreB) wins++;
                        } else if (isPlayerB) {
                            totalPoints += (m.scoreB || 0);
                            if (m.scoreB > m.scoreA) wins++;
                        }
                    }
                });
                return { 
                    wins
                    , total
                    , losses: total - wins
                    , winRate: total === 0 ? 0 : (wins / total) * 100 
                    , totalPoints
                    , avgPoints: total === 0 ? 0 : (totalPoints / total)                    
                    };
            };

            const getAdvancedStats = (memberId) => {
                const playerMatches = matches.filter(m => [...(m.teamA || []), ...(m.teamB || [])].some(p => p.id === memberId));
                if (playerMatches.length === 0) return { partnerAvg: 0, myTeamAvg: 0, oppTeamAvg: 0 };

                let totalPartnerRating = 0;
                let totalMyTeamRating = 0;
                let totalOppTeamRating = 0;
                let partnerCount = 0;
                let count = 0;

                playerMatches.forEach(m => {
                    const isTeamA = m.teamA.some(p => p.id === memberId);
                    const myTeam = isTeamA ? m.teamA : m.teamB;
                    const oppTeam = isTeamA ? m.teamB : m.teamA;

                    const me = myTeam.find(p => p.id === memberId);
                    const partner = myTeam.find(p => p.id !== memberId);
                    
                    const myR = me?.prevRating || INITIAL_RATING;
                    const pR = partner?.prevRating || INITIAL_RATING;
                    const opp1R = oppTeam[0]?.prevRating || INITIAL_RATING;
                    const opp2R = oppTeam[1]?.prevRating || INITIAL_RATING;

                    if (partner) {
                        totalPartnerRating += pR;
                        partnerCount++;
                    }
                    totalMyTeamRating += (myR + pR) / 2;
                    totalOppTeamRating += (opp1R + opp2R) / 2;
                    count++;
                });

                return {
                    partnerAvg: partnerCount > 0 ? (totalPartnerRating / partnerCount) : 0,
                    myTeamAvg: count > 0 ? (totalMyTeamRating / count) : 0,
                    oppTeamAvg: count > 0 ? (totalOppTeamRating / count) : 0
                };
            };

            // 레이팅 분포 데이터 계산 메모이제이션
            const distributionStats = React.useMemo(() => {
                if (members.length === 0) return { data: [], maxCount: 0 };
                
                const ratings = members.map(m => m.rating || INITIAL_RATING);
                const minRating = Math.floor(Math.min(...ratings) * 10) / 10;
                const maxRating = Math.floor(Math.max(...ratings) * 10) / 10;
                
                const dist = {};
                // 최소~최대 구간을 0으로 초기화 (빈 구간도 표시하기 위함)
                for (let r = minRating; r <= maxRating + 0.05; r += 0.1) {
                    dist[r.toFixed(1)] = 0;
                }
                
                // 실제 인원 카운트
                members.forEach(m => {
                    const rating = m.rating || INITIAL_RATING;
                    const interval = (Math.floor(rating * 10) / 10).toFixed(1);
                    dist[interval] = (dist[interval] || 0) + 1;
                });
                
                // 배열로 변환 후 내림차순 정렬 (높은 점수가 위로)
                const data = Object.keys(dist)
                    .sort((a, b) => parseFloat(b) - parseFloat(a))
                    .map(interval => ({ interval, count: dist[interval] }));
                    
                const maxCount = Math.max(...data.map(d => d.count), 1);
                
                return { data, maxCount };
            }, [members]);

            // 파트너십 통계 계산 로직
            const partnershipStats = React.useMemo(() => {
                if (matches.length === 0) return [];
                const duos = {};

                matches.forEach(m => {
                    const processTeam = (team, win) => {
                        if (!team || team.length !== 2) return;
                        const ids = team.map(p => p.id).sort();
                        const key = ids.join('|');
                        if (!duos[key]) {
                            duos[key] = { names: team.map(p => p.name).sort().join(' & '), total: 0, wins: 0 };
                        }
                        duos[key].total += 1;
                        if (win) duos[key].wins += 1;
                    };
                    processTeam(m.teamA, m.scoreA > m.scoreB);
                    processTeam(m.teamB, m.scoreB > m.scoreA);
                });

                return Object.values(duos)
                    .filter(d => d.total >= MIN_PARTNER_MATCHES)
                    .map(d => ({ ...d, winRate: (d.wins / d.total) * 100 }))
                    //.sort((a, b) => b.winRate - a.winRate);
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 7); // 상위 7개 데이터만 추출                    
            }, [matches]);

            const togglePlayer = (member) => {
                const inA = teamA.find(m => m.id === member.id);
                const inB = teamB.find(m => m.id === member.id);
                if (inA) setTeamA(teamA.filter(m => m.id !== member.id));
                else if (inB) setTeamB(teamB.filter(m => m.id !== member.id));
                else {
                    if (teamA.length < 2) setTeamA([...teamA, member]);
                    else if (teamB.length < 2) setTeamB([...teamB, member]);
                    else showToast("팀 구성(4인)이 완료되었습니다.");
                }
            };

            const getTeamAvg = (team) => {
                if (team.length === 0) return 0;
                return team.reduce((acc, cur) => acc + (cur.rating || INITIAL_RATING), 0) / team.length;
            };

            const calculateMatchUpdate = (tA, tB, sA, sB) => {
                const avgA = tA.reduce((acc, cur) => acc + (cur.rating || INITIAL_RATING), 0) / tA.length;
                const avgB = tB.reduce((acc, cur) => acc + (cur.rating || INITIAL_RATING), 0) / tB.length;
                
                const deltaA_Avg = calculateRatingChange(avgA, avgB, sA, sB);
                const deltaB_Avg = calculateRatingChange(avgB, avgA, sB, sA);
                
                const totalPotA = deltaA_Avg * 2;
                const totalPotB = deltaB_Avg * 2;

                const getTeamUpdates = (team, totalPot, isWin) => {
                    const sumRating = team.reduce((sum, p) => sum + (p.rating || INITIAL_RATING), 0);
                    return team.map(p => {
                        const myRating = p.rating || INITIAL_RATING;
                        const partner = team.find(o => o.id !== p.id);
                        const partnerRating = partner ? (partner.rating || INITIAL_RATING) : myRating;
                        
                        // 지수 설정 (2 또는 3을 권장)
                        // 1이면 기존과 동일, 2이면 제곱, 3이면 세제곱...
                        const exponent = 2; 

                        const myPow = Math.pow(myRating, exponent);
                        const partnerPow = Math.pow(partnerRating, exponent);
                        const sumPow = myPow + partnerPow;

                        let weight;
                        if (isWin) {
                            // 승리 시: 내 점수가 높을수록 더 큰 비중을 가져감
                            weight = sumPow > 0 ? (myPow / sumPow) : 0.5;
                        } else {
                            // 패배 시: 파트너 점수가 높을수록 파트너 비중을 크게 계산 (또는 그 반대로 기획에 따라 조정)
                            weight = sumPow > 0 ? (partnerPow / sumPow) : 0.5;
                        }

                        const change = Number((totalPot * weight).toFixed(3));
                        return {
                            id: p.id,
                            name: p.name,
                            prevRating: myRating,
                            afterRating: Number((myRating + change).toFixed(3)),
                            change
                        };
                    });
                };

                const teamAWithChanges = getTeamUpdates(tA, totalPotA, sA > sB);
                const teamBWithChanges = getTeamUpdates(tB, totalPotB, sB > sA);

                return { teamAWithChanges, teamBWithChanges, deltaA_Avg, deltaB_Avg };
            };

            const saveMatch = async () => {
                if (teamA.length !== 2 || teamB.length !== 2) {
                    showToast("각 팀에 2명씩 선택해주세요.");
                    return;
                }
                const { teamAWithChanges, teamBWithChanges, deltaA_Avg, deltaB_Avg } = calculateMatchUpdate(teamA, teamB, scoreA, scoreB);
                
                const nextSeq = getMaxSeq() + 1; 

                const batch = db.batch();
                const matchRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc();
                batch.set(matchRef, {
                    matchSeq: nextSeq,
                    teamA: teamAWithChanges, teamB: teamBWithChanges,
                    scoreA, scoreB, deltaA: deltaA_Avg, deltaB: deltaB_Avg,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                [...teamAWithChanges, ...teamBWithChanges].forEach(p => {
                    batch.update(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(p.id), { rating: p.afterRating });
                });
                try {
                    await batch.commit();
                    showToast("결과 저장 완료");
                    setTeamA([]); setTeamB([]); setScoreA(11); setScoreB(11);
                } catch (e) { showToast("저장 실패"); }
            };

            const handleBulkUpload = async () => {
                const lines = bulkText.split('\n').filter(l => l.trim());
                if (lines.length === 0) return;

                let successCount = 0;
                let errorMessages = [];
                
                let currentSeq = getMaxSeq();

                const currentMemberMap = {};
                members.forEach(m => {
                    currentMemberMap[m.name] = { ...m };
                });

                for (const line of lines) {
                    try {
                        const regex = /(?:(\d{4}\.\d{2}\.\d{2})\s+)?(.+?)\s*&\s*(.+?)\s+vs\s+(.+?)\s*&\s*(.+?)\s+(\d+)\s*:\s*(\d+)/i;
                        const match = line.match(regex);
                        if (!match) {
                            errorMessages.push(`형식 오류: ${line.substring(0, 20)}...`);
                            continue;
                        }

                        const dateStr = match[1];
                        const pNames = [match[2].trim(), match[3].trim(), match[4].trim(), match[5].trim()];
                        const scA = parseInt(match[6]);
                        const scB = parseInt(match[7]);
                        
                        const missingPlayers = pNames.filter(name => !currentMemberMap[name]);
                        if (missingPlayers.length > 0) {
                            errorMessages.push(`멤버 없음: ${missingPlayers.join(', ')}`);
                            continue;
                        }

                        const tA = [currentMemberMap[pNames[0]], currentMemberMap[pNames[1]]];
                        const tB = [currentMemberMap[pNames[2]], currentMemberMap[pNames[3]]];

                        let createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        if (dateStr) {
                            const [y, m, d] = dateStr.split('.');
                            const dateObj = new Date(parseInt(y), parseInt(m) - 1, parseInt(d), 12, 0, 0);
                            createdAt = firebase.firestore.Timestamp.fromDate(dateObj);
                        }

                        const { teamAWithChanges, teamBWithChanges, deltaA_Avg, deltaB_Avg } = calculateMatchUpdate(tA, tB, scA, scB);
                        
                        currentSeq++; 

                        const batch = db.batch();
                        const matchRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc();
                        
                        batch.set(matchRef, {
                            matchSeq: currentSeq,
                            teamA: teamAWithChanges, teamB: teamBWithChanges,
                            scoreA: scA, scoreB: scB, deltaA: deltaA_Avg, deltaB: deltaB_Avg,
                            createdAt: createdAt
                        });

                        [...teamAWithChanges, ...teamBWithChanges].forEach(p => {
                            batch.update(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(p.id), { rating: p.afterRating });
                            if (currentMemberMap[p.name]) {
                                currentMemberMap[p.name].rating = p.afterRating;
                            }
                        });

                        await batch.commit(); 
                        successCount++;
                    } catch (err) {
                        errorMessages.push(`처리 실패: ${line.substring(0, 10)}`);
                    }
                }

                if (errorMessages.length > 0) {
                    alert(`총 ${successCount}건 성공\n에러:\n${errorMessages.slice(0, 5).join('\n')}${errorMessages.length > 5 ? '\n...' : ''}`);
                } else {
                    showToast(`${successCount}건 일괄 업로드 완료`);
                }
                setBulkText("");
                setShowBulkUpload(false);
            };

            const addMembers = async () => {
                if (!newMemberText.trim()) return;
                const entries = newMemberText.split(/[,\n]/).map(n => n.trim()).filter(n => n);
                const batch = db.batch();
                let addedCount = 0;

                entries.forEach(entry => {
                    const match = entry.match(/^([^\d\s]+)\s*(\d*\.?\d+)$/);
                    let name, rating;
                    if (match) {
                        name = match[1].trim();
                        rating = parseFloat(match[2]);
                    } else {
                        name = entry;
                        rating = INITIAL_RATING;
                    }

                    if (!members.find(m => m.name === name)) {
                        const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc();
                        batch.set(ref, { 
                            name, 
                            rating: isNaN(rating) ? INITIAL_RATING : rating, 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                        });
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    await batch.commit();
                    showToast(`${addedCount}명의 멤버가 등록되었습니다.`);
                } else {
                    showToast("새로 등록할 멤버가 없습니다.");
                }
                setNewMemberText("");
            };

            const downloadMembersCSV = () => {
                if (members.length === 0) {
                    showToast("다운로드할 멤버가 없습니다.");
                    return;
                }
                const headers = ["이름", "supr 레이팅", "총 경기수", "승", "패", "승률", "등록일"];
                const rows = members.map(m => {
                    const stats = getMemberStats(m.id);
                    return [
                        m.name, 
                        (m.rating || INITIAL_RATING).toFixed(3), 
                        stats.total, stats.wins, stats.losses, stats.winRate.toFixed(1) + "%",
                        formatDate(m.createdAt)
                    ];
                });
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                link.setAttribute("href", url);
                link.setAttribute("download", `sdpc_members_${dateStr}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                showToast("선수 명단 다운로드 완료");
            };

            const getFilteredMatches = () => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const searchLower = nameSearch.toLowerCase().trim();
                
                return matches.filter(m => {
                    let datePass = true;
                    if (historyFilter !== 'all') {
                        if (!m.createdAt) datePass = false;
                        else {
                            const d = m.createdAt.toDate();
                            const matchDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                            if (historyFilter === 'today') datePass = (matchDate.getTime() === today.getTime());
                            else if (historyFilter === 'week') {
                                const start = new Date(today); start.setDate(today.getDate() - today.getDay());
                                datePass = (matchDate >= start);
                            } else if (historyFilter === 'lastweek') {
                                const start = new Date(today); start.setDate(today.getDate() - today.getDay() - 7);
                                const end = new Date(today); end.setDate(today.getDate() - today.getDay() - 1);
                                datePass = (matchDate >= start && matchDate <= end);
                            } else if (historyFilter === 'month') {
                                datePass = (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear());
                            } else if (historyFilter === 'lastmonth') {
                                let lastMonth = now.getMonth() - 1;
                                let lastYear = now.getFullYear();
                                if (lastMonth < 0) { lastMonth = 11; lastYear--; }
                                datePass = (d.getMonth() === lastMonth && d.getFullYear() === lastYear);
                            }
                        }
                    }
                    let namePass = true;
                    if (searchLower) {
                        const players = [...(m.teamA || []), ...(m.teamB || [])];
                        namePass = players.some(p => p.name.toLowerCase().includes(searchLower));
                    }
                    return datePass && namePass;
                });
            };

            const downloadHistoryCSV = () => {
                const filtered = getFilteredMatches();
                if (filtered.length === 0) {
                    showToast("다운로드할 데이터가 없습니다.");
                    return;
                }
                const headers = [
                    "기록ID", "일시", "점수A", "점수B", 
                    "A선수1", "A1_이전", "A1_이후", "A1_변동",
                    "A선수2", "A2_이전", "A2_이후", "A2_변동",
                    "B선수1", "B1_이전", "B1_이후", "B1_변동",
                    "B선수2", "B2_이전", "B2_이후", "B2_변동"
                ];
                const rows = filtered.map(m => {
                    const pA1 = m.teamA?.[0] || {};
                    const pA2 = m.teamA?.[1] || {};
                    const pB1 = m.teamB?.[0] || {};
                    const pB2 = m.teamB?.[1] || {};
                    return [
                        m.matchSeq !== undefined ? m.matchSeq : m.id, formatDate(m.createdAt), m.scoreA, m.scoreB,
                        pA1.name || "-", (pA1.prevRating || 0).toFixed(3), (pA1.afterRating || 0).toFixed(3), (pA1.change || 0).toFixed(3),
                        pA2.name || "-", (pA2.prevRating || 0).toFixed(3), (pA2.afterRating || 0).toFixed(3), (pA2.change || 0).toFixed(3),
                        pB1.name || "-", (pB1.prevRating || 0).toFixed(3), (pB1.afterRating || 0).toFixed(3), (pB1.change || 0).toFixed(3),
                        pB2.name || "-", (pB2.prevRating || 0).toFixed(3), (pB2.afterRating || 0).toFixed(3), (pB2.change || 0).toFixed(3)
                    ];
                });
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                const now = new Date();
                const dateStr2 = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                link.setAttribute("href", url);
                link.setAttribute("download", `sdpc_history_${historyFilter}_${dateStr2}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                showToast("기록 다운로드 완료");
            };

            const handleMemberClick = (name) => {
                setNameSearch(name);
                setHistoryFilter('all');
                setTab('history');
                setDetailMember(null);
            };

            const sortedAdminMembers = React.useMemo(() => {
                const list = [...members];
                if (adminSort === 'name') {
                    return list.sort((a, b) => a.name.localeCompare(b.name));
                } else if (adminSort === 'rating') {
                    return list.sort((a, b) => (b.rating || INITIAL_RATING) - (a.rating || INITIAL_RATING));
                } else if (adminSort === 'matches') {
                    return list.sort((a, b) => getMemberStats(b.id).total - getMemberStats(a.id).total);
                }
                return list;
            }, [members, adminSort, matches]);

            const avgA = getTeamAvg(teamA);
            const avgB = getTeamAvg(teamB);
            const hasPlayers = teamA.length > 0 || teamB.length > 0;
            const sensitivity2 = 1.3; 
            const expectedWinA = hasPlayers ? (1 / (1 + Math.pow(10, (avgB - avgA)*sensitivity2))) * 100 : 50;
            const expectedWinB = hasPlayers ? (1 / (1 + Math.pow(10, (avgA - avgB)*sensitivity2))) * 100 : 50;

            let previewUpdate = null;
            if (teamA.length > 0 && teamB.length > 0) {
                previewUpdate = calculateMatchUpdate(teamA, teamB, scoreA, scoreB);
            }

            const allFilteredMatches = getFilteredMatches();
            const totalPages = Math.ceil(allFilteredMatches.length / ITEMS_PER_PAGE);
            const currentMatches = allFilteredMatches.slice(
                (currentPage - 1) * ITEMS_PER_PAGE, 
                currentPage * ITEMS_PER_PAGE
            );

            return (
                <div className="min-h-screen pb-20 max-w-lg mx-auto bg-white shadow-2xl overflow-hidden relative text-gray-800">
                    <Toast message={toast} onClose={() => setToast(null)} />
                    <PasswordCheck 
                        isOpen={pwdModal.isOpen} onClose={() => setPwdModal({...pwdModal, isOpen: false})} 
                        onSuccess={pwdModal.onSuccess} requiredPwd={pwdModal.reqPwd} title={pwdModal.title}
                    />
                    
                    {/* 레이팅 분포도 모달 */}
                    <Modal isOpen={showDistModal} title="레이팅 구간별 분포 (0.1)" onClose={() => setShowDistModal(false)}>
                        <div className="space-y-2.5 px-1 py-2">
                            {distributionStats.data.map(d => {
                                const widthPct = d.count === 0 ? 0 : (d.count / distributionStats.maxCount) * 100;
                                const barColor = getBarColorClass(d.interval);
                                return (
                                    <div key={d.interval} className="flex items-center gap-3 text-xs">
                                        <div className="w-8 text-right font-mono font-black text-slate-500">{d.interval}</div>
                                        <div className="flex-1 h-6 bg-slate-50 rounded-r-xl border-y border-r border-slate-100 flex items-center shadow-inner overflow-visible">
                                            {d.count > 0 && (
                                                <div
                                                    className={`h-full ${barColor} rounded-r-xl transition-all duration-700 ease-out shadow-sm flex items-center justify-end px-2`}
                                                    style={{ width: `${Math.max(widthPct, 15)}%` }} // 최소 너비 보장하여 숫자 표시 공간 확보
                                                >
                                                    <span className="text-white font-black text-[10px] drop-shadow-md">{d.count}명</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center text-[11px] font-bold text-slate-400">
                            <span>총 인원</span>
                            <span className="text-slate-800 text-sm font-black">{members.length}명</span>
                        </div>
                    </Modal>

                    {/* 파트너 통계 모달 */}
                    <Modal isOpen={showPartnerModal} title={`파트너 통계 (최소 ${MIN_PARTNER_MATCHES}경기)`} onClose={() => setShowPartnerModal(false)}>
                        <div className="space-y-3 px-1 py-1">
                            {partnershipStats.length > 0 ? (
                                partnershipStats.map((d, idx) => (
                                    <div key={idx} className="bg-gray-50 p-1 rounded-2xl border border-gray-100">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="text-xs font-black text-slate-800 break-words flex-1 pr-4">{d.names}</span>

                                            <span className="text-xs font-grey text-slate-800 break-words flex-1 pr-4">  {d.total}G ({d.wins}W {d.total - d.wins}L)</span>  


                                            <span className="text-sm font-black text-pickle-600">{d.winRate.toFixed(1)}%</span>

                                        </div>
                                        <div className="w-full h-1.5 bg-gray-200 rounded-full mb-1">
                                            <div className="h-full bg-pickle-500 rounded-full transition-all duration-1000" style={{ width: `${d.winRate}%` }}></div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="p-10 text-center text-gray-400 text-sm">해당 기준({MIN_PARTNER_MATCHES}경기 이상)을 충족하는 파트너 조합이 아직 없습니다.</div>
                            )}
                        </div>
                    </Modal>

                    <Modal isOpen={!!detailMember} title={`${detailMember?.name} 선수 이력`} onClose={() => setDetailMember(null)}>
                        {detailMember && (
                            <div className="space-y-1">
                                <div className="grid grid-cols-5 gap-1">
                                    {(() => {
                                        const advStats = getAdvancedStats(detailMember.id);
                                        {/* 변수에 차이값을 먼저 저장하면 코드가 더 깔끔해집니다 */}
                                        const scoreDiff = advStats.myTeamAvg - advStats.oppTeamAvg;

                                        return (
                                            <>
                                                <div className="bg-sky-50 p-2 rounded-xl border border-gray-100 text-center">
                                                    <div className="text-[9px] text-gray-400 font-bold uppercase"> 파트너 평균</div>
                                                    <div className="text-sm font-black text-slate-700 mt-0.5">{advStats.partnerAvg.toFixed(3)}</div>
                                                </div>
                                                <div className="bg-green-50 p-2 rounded-xl border border-gray-100 text-center">
                                                    <div className="text-[9px] text-gray-400 font-bold uppercase">내팀 평균</div>
                                                    <div className="text-sm font-black text-slate-700 mt-0.5">{advStats.myTeamAvg.toFixed(3)}</div>
                                                </div>
                                                <div className="bg-orange-50 p-2 rounded-xl border border-gray-100 text-center">
                                                    <div className="text-[9px] text-gray-400 font-bold uppercase">상대팀 평균</div>
                                                    <div className="text-sm font-black text-slate-700 mt-0.5">{advStats.oppTeamAvg.toFixed(3)}</div>
                                                </div>
                                                <div className="bg-grey-90 p-2 rounded-xl border border-gray-100 text-center">
                                                    <div className="text-[9px] text-gray-400 font-bold uppercase">전력차이</div>
                                                    <div className={`px-3 py-1 rounded-lg text-[12px] font-black ${scoreDiff.toFixed(2) >= 0.01 ? 'bg-emerald-100/80 text-emerald-700' : scoreDiff.toFixed(2) >= 0 ? 'bg-white/80 text-gray-700' : 'bg-red-100/80 text-red-700'}`}>
                                                        {scoreDiff.toFixed(2)}
                                                    </div>
                                                </div>
                                                <div className="bg-grey-90 p-2 rounded-xl border border-gray-100 text-center">
                                                    <div className="text-[9px] text-gray-400 font-bold uppercase">승률</div>
                                                    <div className={`px-2 py-1 rounded-lg text-[12px] font-black ${getMemberStats(detailMember.id).winRate >= 60 ? 'bg-emerald-100/80 text-emerald-700' : getMemberStats(detailMember.id).winRate >= 40 ? 'bg-white/80 text-gray-700' : 'bg-red-100/80 text-red-700'}`}>
                                                        {getMemberStats(detailMember.id).winRate.toFixed(1)}%</div>

                                                </div>

                                            </>
                                        );
                                    })()}
                                </div>

                                <RatingGraph member={detailMember} matches={matches} />
                                <div className="space-y-2">
                                    <div className="text-[10px] text-gray-400 font-black uppercase tracking-widest px-1">최근 전적</div>
                                    <div className="max-h-20 overflow-y-auto pr-1 space-y-1 hide-scrollbar">
                                        {matches.filter(m => [...(m.teamA || []), ...(m.teamB || [])].some(p => p.id === detailMember.id)).slice(0, 10).map(m => {
                                            const isTeamA = m.teamA.some(p => p.id === detailMember.id);
                                            const win = (isTeamA && m.scoreA > m.scoreB) || (!isTeamA && m.scoreB > m.scoreA);
                                            return (
                                                <div key={m.id} className="flex items-center justify-between bg-gray-50 p-1.5 rounded-xl text-[11px] font-bold">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`w-5 h-5 rounded-lg flex items-center justify-center text-white ${win ? 'bg-emerald-500' : 'bg-rose-400'}`}>
                                                            {win ? 'W' : 'L'}
                                                        </span>
                                                        <div className="flex flex-col">
                                                            <span className="text-slate-400 font-mono text-[9px] leading-tight">#{m.matchSeq !== undefined ? m.matchSeq : '-'}</span>
                                                            <span className="text-gray-500 text-[10px] leading-tight">{formatDate(m.createdAt)}</span>
                                                        </div>
                                                    </div>
                                                    <span className="text-slate-700">{m.scoreA} : {m.scoreB}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <button onClick={() => handleMemberClick(detailMember.name)} className="w-full py-2 bg-slate-900 text-white rounded-xl font-black text-xs hover:bg-slate-800 transition-colors mt-2">
                                    <Icon name="history" size={15} /> 경기 기록 보기
                                </button>
                                <div className="p-4 bg-slate-50 flex justify-center border-t mt-2">
                                    <span className="text-[10px] text-slate-400 font-black tracking-widest">Enjoy Pickleball</span>
                                </div>  
                            </div>
                        )}
                    </Modal>

                    <header className="bg-white border-b sticky top-0 z-40 px-4 py-3 shadow-sm">
                        <div className="flex items-center justify-between mb-2">
                            <h1 className="text-xl font-extrabold flex items-center gap-2 text-slate-900">
                                <span className="bg-pickle-600 text-white p-1 rounded-lg">sdpc</span> Songdo Pickleball L3+
                            </h1>
                            <div className={`w-2.5 h-2.5 rounded-full ${loading ? 'bg-yellow-400 animate-pulse' : 'bg-green-500 shadow-sm'}`}></div>
                        </div>
                        <nav className="flex justify-between items-center bg-gray-100/80 rounded-2xl p-1">
                            {[
                                { id: 'match', icon: 'gamepad-2', label: '경기' },
                                { id: 'stats', icon: 'trophy', label: '랭킹' },
                                { id: 'history', icon: 'history', label: '기록' },
                                { id: 'admin', icon: 'sliders', label: '관리' },
                                { id: 'member', icon: 'users', label: '멤버' },
                            ].map(item => (
                                <button key={item.id} onClick={() => {
                                    if (item.id === 'member') {
                                        openPwd(SDS_MEMBER_TAB, "멤버 관리 접근", () => setTab(item.id));
                                    } else {
                                        setTab(item.id);
                                    }
                                }}
                                    className={`flex-1 flex flex-col items-center py-2.5 rounded-xl transition-all ${tab === item.id ? 'text-pickle-600 bg-white shadow-sm font-bold' : 'text-gray-400'}`}>
                                    <Icon name={item.icon} size={20} />
                                    <span className="text-[12px] mt-0.5">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                    </header>

                    <main className="p-4 fade-in pb-[70px]">
                        {tab === 'match' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="text-center w-[40%]">
                                            <div className="text-[10px] text-emerald-400/80 mb-1 font-black uppercase tracking-widest flex items-center justify-center gap-1">
                                                {expectedWinA > expectedWinB && hasPlayers && <Icon name="crown" size={12} className="text-yellow-400" />}
                                                Team A
                                            </div>
                                            <div className="text-3xl font-black text-emerald-400">{avgA.toFixed(3)}</div>
                                            <div className="text-[11px] text-emerald-300/80 font-bold mt-1">예상 승률 {expectedWinA.toFixed(1)}%</div>
                                        </div>
                                        <div className="text-lg font-black text-slate-500/50 italic">VS</div>
                                        <div className="text-center w-[40%]">
                                            <div className="text-[10px] text-red-400/80 mb-1 font-black uppercase tracking-widest flex items-center justify-center gap-1">
                                                Team B
                                                {expectedWinB > expectedWinA && hasPlayers && <Icon name="crown" size={12} className="text-yellow-400" />}
                                            </div>
                                            <div className="text-3xl font-black text-red-400">{avgB.toFixed(3)}</div>
                                            <div className="text-[11px] text-red-300/80 font-bold mt-1">예상 승률 {expectedWinB.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                    <div className="w-full h-1.5 bg-slate-700/50 rounded-full mb-6 flex overflow-hidden">
                                        <div className="h-full bg-emerald-500 transition-all duration-500 ease-out" style={{ width: `${expectedWinA}%` }}></div>
                                        <div className="h-full bg-red-500 transition-all duration-500 ease-out" style={{ width: `${expectedWinB}%` }}></div>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3 bg-slate-700/50 p-1.5 rounded-2xl border border-white/5">
                                            <button onClick={() => setScoreA(s => Math.max(0, s-1))} className="w-9 h-9 rounded-xl bg-slate-700 flex items-center justify-center active:scale-90 transition-transform">-</button>
                                            <span className="text-4xl font-black w-12 text-center text-emerald-50">{scoreA}</span>
                                            <button onClick={() => setScoreA(s => s+1)} className="w-9 h-9 rounded-xl bg-emerald-600 hover:bg-emerald-500 flex items-center justify-center shadow-lg shadow-emerald-500/30 active:scale-90 transition-transform">+</button>
                                        </div>
                                        <div className="flex items-center gap-3 bg-slate-700/50 p-1.5 rounded-2xl border border-white/5">
                                            <button onClick={() => setScoreB(s => Math.max(0, s-1))} className="w-9 h-9 rounded-xl bg-slate-700 flex items-center justify-center active:scale-90 transition-transform">-</button>
                                            <span className="text-4xl font-black w-12 text-center text-red-50">{scoreB}</span>
                                            <button onClick={() => setScoreB(s => s+1)} className="w-9 h-9 rounded-xl bg-red-600 hover:bg-red-500 flex items-center justify-center shadow-lg shadow-red-500/30 active:scale-90 transition-transform">+</button>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={saveMatch} className="w-full py-2 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-emerald-600/20 hover:bg-emerald-700 flex justify-center items-center gap-3 active:scale-95 transition-transform">
                                    <Icon name="save" size={28} /> 경기 결과 저장
                                </button>
                                <div>
                                    <h3 className="text-slate-800 font-black mb-4 flex items-center gap-2"><Icon name="users" size={18} /> 선수 명단 <span className="text-[10px] text-gray-400 font-medium">(레이팅 변동 예상치 표시)</span></h3>
                                    <div className="grid grid-cols-4 gap-2.5">
                                        {members.map(m => {
                                            const isA = teamA.find(p => p.id === m.id);
                                            const isB = teamB.find(p => p.id === m.id);
                                            let expectedChange = null;
                                            if (previewUpdate) {
                                                if (isA) {
                                                    const previewP = previewUpdate.teamAWithChanges.find(p => p.id === m.id);
                                                    if (previewP) expectedChange = previewP.change;
                                                } else if (isB) {
                                                    const previewP = previewUpdate.teamBWithChanges.find(p => p.id === m.id);
                                                    if (previewP) expectedChange = previewP.change;
                                                }
                                            }
                                            return (
                                                <button key={m.id} onClick={() => togglePlayer(m)}
                                                    className={`p-2 rounded-2xl border-2 text-sm flex flex-col items-center justify-center gap-0.5 transition-all ${isA ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : isB ? 'bg-red-50 border-red-500 text-red-700' : 'bg-white border-gray-100 hover:border-gray-300 min-h-[64px]'}`}>
                                                    <span className="font-extrabold truncate w-full text-center">{m.name}</span>
                                                    <div className="flex flex-col items-center leading-tight">
                                                        <span className={`text-[10px] font-mono font-bold ${isA||isB ? 'opacity-60' : 'text-gray-400'}`}>{(m.rating || INITIAL_RATING).toFixed(3)}</span>
                                                        {expectedChange !== null && (
                                                            <span className={`text-[10px] font-black ${expectedChange > 0 ? 'text-emerald-500' : expectedChange < 0 ? 'text-rose-500' : 'text-gray-400'}`}>
                                                                {expectedChange > 0 ? '+' : ''}{expectedChange.toFixed(3)}
                                                            </span>
                                                        )}
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-50 flex justify-center border-t">
                                    <span className="text-[10px] text-slate-400 italic font-black tracking-widest">Enjoy Pickleball</span>
                                </div>
                            </div>
                        )}

                        {tab === 'history' && (
                            <div className="space-y-4">
                                <div className="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm space-y-4">
                                    <div className="space-y-3">
                                        <div className="flex items-center gap-2 bg-gray-50 border border-gray-100 rounded-2xl px-3 py-2 focus-within:ring-2 ring-emerald-500/20 transition-all">
                                            <Icon name="search" size={16} className="text-gray-400" />
                                            <input type="text" placeholder="참여 플레이어 이름으로 검색" className="bg-transparent border-none outline-none text-sm font-bold w-full text-slate-800 placeholder:text-gray-300" value={nameSearch} onChange={(e) => setNameSearch(e.target.value)} />
                                            {nameSearch && <button onClick={() => setNameSearch('')} className="text-gray-300 hover:text-gray-500 transition-colors"><Icon name="x-circle" size={16} /></button>}
                                        </div>
                                        <div className="flex flex-wrap gap-1.5 overflow-x-auto pb-1 hide-scrollbar">
                                            {['today', 'week', 'lastweek', 'month', 'lastmonth', 'all'].map(id => (
                                                <button key={id} onClick={() => setHistoryFilter(id)} className={`px-4 py-2 rounded-xl text-[11px] font-black transition-all whitespace-nowrap ${historyFilter === id ? 'bg-slate-900 text-white shadow-md' : 'bg-gray-50 text-gray-400 border border-transparent hover:bg-gray-100'}`}>
                                                    {id === 'today' ? '오늘' : id === 'week' ? '이번주' : id === 'lastweek' ? '지난주' : id === 'month' ? '이번달' : id === 'lastmonth' ? '지난달' : '전체'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowBulkUpload(true)} className="flex-1 flex items-center justify-center gap-1.5 py-3 bg-emerald-50 text-emerald-600 rounded-xl text-[11px] font-black hover:bg-emerald-100 transition-colors">
                                            <Icon name="upload" size={14} /> 일괄 업로드
                                        </button>
                                        <button onClick={() => openPwd(SDS_HISTORY_DEL_ONE, "기록 다운로드", async () => {
                                            try {
                                                await downloadHistoryCSV();
                                                // 필요 시 성공 메시지 추가
                                                // showToast("다운로드가 완료되었습니다.");
                                            } catch (e) { 
                                                showToast("다운로드 중 오류가 발생했습니다."); 
                                            }
                                            })} 
                                            className="flex-1 flex items-center justify-center gap-1.5 py-3 bg-slate-50 text-slate-600 rounded-xl text-[11px] font-black hover:bg-slate-100 transition-colors"
                                        >
                                        <Icon name="download" size={14} /> $기록 다운로드
                                        </button>

                                    </div>
                                </div>
                                {showBulkUpload && (
                                    <div className="bg-emerald-50 p-4 rounded-3xl border border-emerald-100 space-y-3 fade-in">
                                        <div className="flex justify-between items-center">
                                            <h4 className="text-xs font-black text-emerald-800 flex items-center gap-2"><Icon name="file-text" size={14} /> 경기 결과 일괄 입력</h4>
                                            <button onClick={() => setShowBulkUpload(false)} className="text-emerald-400 hover:text-emerald-600"><Icon name="x" size={16} /></button>
                                        </div>
                                        <textarea value={bulkText} onChange={(e) => setBulkText(e.target.value)} placeholder="2026.02.18 홍길동 & 정약용 vs 유재석 & 박지성 11 : 4&#13;&#10;(날짜 생략 시 현재 시간으로 등록됨, 한 줄에 한 경기씩 입력)" className="w-full h-32 p-3 text-xs font-mono rounded-xl border border-emerald-200 outline-none focus:ring-2 focus:ring-emerald-400 bg-white" />
                                        <button onClick={handleBulkUpload} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-black text-xs shadow-lg shadow-emerald-600/20 hover:bg-emerald-700">업로드 시작</button>
                                    </div>
                                )}
                                
                                <div className="px-1 text-[11px] font-black text-slate-400 flex justify-between items-end pb-1">
                                    <span>총 <span className="text-emerald-500 text-xs">{allFilteredMatches.length}</span>건 <span className="font-medium text-[10px]">(최신 기록순 정렬)</span></span>
                                </div>

                                <div className="space-y-1.5">
                                    {currentMatches.map(m => (
                                        <div key={m.id} className="bg-white rounded-3xl p-2 shadow-sm border border-gray-100 group relative overflow-hidden fade-in">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex flex-col gap-1.5">
                                                    <div className="text-[10px] text-gray-400 font-black bg-gray-50 px-2 py-1 rounded-lg border border-gray-100 w-fit">{formatDate(m.createdAt)}</div>
                                                    <div className="text-[10px] font-black text-slate-500 flex items-baseline">
                                                        No. {m.matchSeq !== undefined ? m.matchSeq : '-'}
                                                        <span className="text-[8px] text-slate-300 font-mono font-medium ml-1.5">doc:{m.id.substring(0,5)}</span>
                                                    </div>
                                                </div>
                                                <button onClick={() => openPwd(SDS_HISTORY_DEL_ONE, "경기 기록 삭제", async () => {
                                                    try {
                                                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('matches').doc(m.id).delete();
                                                        showToast("기록이 삭제되었습니다.");
                                                    } catch (e) { showToast("삭제 중 오류가 발생했습니다."); }
                                                })} className="w-8 h-8 flex items-center justify-center rounded-xl bg-red-50 text-red-300 hover:text-red-600 hover:bg-red-100 transition-all active:scale-90">
                                                    <Icon name="trash-2" size={16} />
                                                </button>
                                            </div>
                                            <div className="flex items-center justify-between gap-3 text-center">
                                                <div className="flex-1 text-right">
                                                    {m.teamA?.map(p => (
                                                        <div key={p.id} className="mb-2 last:mb-0">
                                                            <div 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    const member = members.find(mem => mem.id === p.id) || { ...p, rating: p.afterRating };
                                                                    setDetailMember(member);
                                                                }}
                                                                className="text-xs font-black text-slate-800 cursor-pointer hover:text-pickle-600 hover:underline decoration-dotted underline-offset-4 transition-all"
                                                            >
                                                                {p.name}
                                                            </div>
                                                            <div className="text-[9px] text-slate-400 font-mono font-bold flex items-center justify-end gap-1">
                                                                {p.prevRating?.toFixed(3)} → <span className="text-emerald-600 font-black">{p.afterRating?.toFixed(3)}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="bg-slate-50 px-4 py-3 rounded-2xl border border-slate-100 min-w-[85px]">
                                                    <div className="flex items-center gap-1 font-black text-2xl tracking-tighter justify-center">
                                                        <span className={m.scoreA > m.scoreB ? 'text-emerald-500' : 'text-slate-300'}>{m.scoreA}</span>
                                                        <span className="text-slate-200 text-lg">:</span>
                                                        <span className={m.scoreB > m.scoreA ? 'text-red-500' : 'text-slate-300'}>{m.scoreB}</span>
                                                    </div>
                                                </div>
                                                <div className="flex-1 text-left">
                                                    {m.teamB?.map(p => (
                                                        <div key={p.id} className="mb-2 last:mb-0">
                                                            <div 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    const member = members.find(mem => mem.id === p.id) || { ...p, rating: p.afterRating };
                                                                    setDetailMember(member);
                                                                }}
                                                                className="text-xs font-black text-slate-800 cursor-pointer hover:text-pickle-600 hover:underline decoration-dotted underline-offset-4 transition-all"
                                                            >
                                                                {p.name}
                                                            </div>
                                                            <div className="text-[9px] text-slate-400 font-mono font-bold flex items-center justify-start gap-1">
                                                                {p.prevRating?.toFixed(3)} → <span className="text-red-600 font-black">{p.afterRating?.toFixed(3)}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {totalPages > 1 && (
                                    <div className="flex justify-center items-center gap-4 pt-4 border-t border-gray-100">
                                        <button
                                            onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                            disabled={currentPage === 1}
                                            className="p-3 rounded-xl bg-white shadow-sm border border-gray-100 text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
                                        >
                                            <Icon name="chevron-left" size={16} />
                                        </button>
                                        <span className="text-xs font-black text-slate-400 tracking-widest">
                                            {currentPage} / {totalPages}
                                        </span>
                                        <button
                                            onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                            disabled={currentPage === totalPages}
                                            className="p-3 rounded-xl bg-white shadow-sm border border-gray-100 text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
                                        >
                                            <Icon name="chevron-right" size={16} />
                                        </button>
                                    </div>
                                )}
                                <div className="p-4 bg-slate-50 flex justify-center border-t">
                                    <span className="text-[10px] text-slate-400 italic font-black tracking-widest">Enjoy Pickleball</span>
                                </div>                                
                            </div>
                        )}

                        {tab === 'stats' && (
                            <div className="space-y-4">
                                <div className="flex justify-end gap-3 px-2">
                                    <button onClick={() => setShowPartnerModal(true)} className="text-xs text-pickle-600 font-black flex items-center gap-1.5 hover:underline decoration-dotted underline-offset-4">
                                        <Icon name="users" size={12} /> Best Duos
                                    </button>
                                    <button onClick={() => setShowDistModal(true)} className="text-xs text-orange-600 font-black flex items-center gap-1.5 hover:underline decoration-dotted underline-offset-4">
                                        <Icon name="bar-chart-horizontal" size={12} /> Segment distribution
                                    </button>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden fade-in">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-slate-900 text-slate-400 text-[11px] font-black tracking-widest whitespace-nowrap">
                                                <tr>
                                                    <th className="px-2 py-2 text-left ">순위</th>
                                                    <th className="px-2 py-2 text-left  min-w-[75px] ">선수</th>
                                                    <th className="px-2 py-2 text-center ">승/경기</th>
                                                    <th className="px-2 py-2 text-center ">Avg.P</th>
                                                    <th className="px-2 py-2 text-center ">승률</th>
                                                    <th className="px-2 py-2 text-right ">SUPR</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[...members].sort((a,b) => (b.rating||INITIAL_RATING) - (a.rating||INITIAL_RATING)).map((m, idx) => {
                                                    const s = getMemberStats(m.id);
                                                    const rating = m.rating || INITIAL_RATING;
                                                    return (
                                                        <tr key={m.id} className={`${getRatingBgClass(rating)} transition-colors group border-b border-white/50 last:border-0`}>
                                                            <td className="px-1 py-2">
                                                                <span className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black ${idx === 0 ? 'bg-amber-100 text-amber-600' : idx === 1 ? 'bg-slate-100 text-slate-600' : idx === 2 ? 'bg-orange-50 text-orange-600' : 'text-slate-500'}`}>
                                                                    {idx + 1}
                                                                </span>
                                                            </td>
                                                            <td className="px-1 py-2">
                                                                <button onClick={() => setDetailMember(m)} className="flex items-center gap-2 group/btn">
                                                                    <span className="font-black text-slate-900 group-hover/btn:text-pickle-600 transition-colors">{m.name}</span>
                                                                </button>
                                                            </td>
                                                            <td className="px-1 py-2 text-center font-mono text-[11px] font-bold">
                                                                <span className="text-emerald-600">{s.wins}</span><span className="text-slate-400 mx-0.5">/</span><span className="text-slate-700">{s.total}</span>
                                                            </td>
                                                            <td className="px-1 py-2 text-center text-[11px] font-mono font-bold text-slate-700">{s.avgPoints.toFixed(1)}</td>
                                                          
                                                            <td className="px-1 py-2 text-center">
                                                                <span className={`px-2 py-1 rounded-lg text-[10px] font-black ${s.winRate >= 60 ? 'bg-emerald-100/80 text-emerald-700' : s.winRate >= 40 ? 'bg-white/80 text-gray-700' : 'bg-red-100/80 text-red-700'}`}>
                                                                    {s.winRate.toFixed(1)}%
                                                                </span>
                                                            </td>
                                                            <td className="px-1 py-2 text-right text-[11px] text-slate-900 font-mono font-black italic">
                                                                {rating.toFixed(3)}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-50 flex justify-center border-t">
                                    <span className="text-[10px] text-slate-400 italic font-black tracking-widest">Enjoy Pickleball</span>
                                </div>
                            </div>
                        )}

                        {tab === 'admin' && (
                            <div className="space-y-4">
                                {!isAdmin ? (
                                    <div className="p-10 text-center bg-white rounded-3xl border border-gray-100 shadow-xl">
                                        <input type="password" inputMode="numeric" placeholder="****" className="border-2 p-4 rounded-2xl w-full max-w-[160px] text-center mb-6 outline-none focus:border-pickle-500 transition-all text-2xl tracking-[1em] font-black" 
                                            value={adminPwdInput} onChange={e => {
                                                setAdminPwdInput(e.target.value);
                                                if (e.target.value === SDS_ADMIN) setIsAdmin(true);
                                            }} />
                                        <p className="text-xs text-slate-400 font-black uppercase tracking-widest">Administrator Login</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="flex bg-gray-100 p-1 rounded-2xl gap-1">
                                            <button onClick={() => setAdminSort('name')} className={`flex-1 py-2 text-[11px] font-black rounded-xl transition-all ${adminSort === 'name' ? 'bg-white text-slate-900 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>
                                                이름순 정렬
                                            </button>
                                            <button onClick={() => setAdminSort('rating')} className={`flex-1 py-2 text-[11px] font-black rounded-xl transition-all ${adminSort === 'rating' ? 'bg-white text-slate-900 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>
                                                레이팅순 정렬
                                            </button>
                                            <button onClick={() => setAdminSort('matches')} className={`flex-1 py-2 text-[11px] font-black rounded-xl transition-all ${adminSort === 'matches' ? 'bg-white text-slate-900 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>
                                                경기수 정렬
                                            </button>
                                        </div>

                                        <div className="border border-gray-100 rounded-2xl overflow-hidden bg-white shadow-sm divide-y divide-gray-50">
                                            {sortedAdminMembers.map((m, idx) => {
                                                const stats = getMemberStats(m.id);
                                                return (          
                                                    <div key={m.id} className="p-2 flex justify-between items-center group hover:bg-gray-50 transition-colors">
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex items-center justify-center bg-slate-900 text-white rounded-lg w-5 h-5 font-black text-[10px]">
                                                                {idx + 1}  
                                                            </div>     
                                                            <span className="font-extrabold text-slate-800 text-sm">{m.name}</span>
                                                        </div>
                                                        <div className="flex items-center">
                                                            <div className="text-[10px] text-gray-400 font-bold bg-gray-100 px-1.5 py-0.5 rounded mr-2">
                                                                {stats.total}경기
                                                            </div>
                                                            <input type="number" step="0.001" defaultValue={(m.rating || INITIAL_RATING).toFixed(3)}
                                                                onBlur={async (e) => {
                                                                    const val = parseFloat(e.target.value);
                                                                    if (!isNaN(val)) {
                                                                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(m.id).update({ rating: Number(val.toFixed(3)) });
                                                                        showToast(`${m.name} 수정 완료`);
                                                                    }
                                                                }}
                                                                className="w-24 border border-gray-200 rounded-xl px-3 py-1.5 text-right font-black font-mono text-xs outline-none focus:border-pickle-500" />
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            <div className="p-4 bg-slate-50 flex justify-center border-t">
                                                <button onClick={() => setIsAdmin(false)} className="text-[10px] text-slate-400 underline font-black uppercase tracking-widest">Logout</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="p-4 bg-slate-50 flex justify-center border-t">
                                    <span className="text-[10px] text-slate-400 italic font-black tracking-widest">Enjoy Pickleball</span>
                                </div>
                            </div>
                        )}

                        {tab === 'member' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <h3 className="font-black text-slate-800 text-base ">sdpc Player</h3>
                                    <button onClick={downloadMembersCSV} className="flex items-center gap-1.5 px-3 py-2 bg-slate-100 text-slate-600 rounded-xl text-[11px] font-black hover:bg-slate-200 transition-colors">
                                        <Icon name="download" size={14} /> 다운로드
                                    </button>
                                </div>
                                <div className="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm space-y-3">
                                    <div className="text-[11px] text-gray-500 font-medium px-1 flex flex-col gap-1">
                                        <span>• 이름 뒤에 숫자를 적으면 해당 점수로 등록됩니다.(기본값:3.000)</span>
                                        <span>• 쉼표(,)나 줄바꿈으로 일괄 등록 가능합니다.</span>
                                    </div>
                                    <textarea value={newMemberText} onChange={e => setNewMemberText(e.target.value)} placeholder="홍길동 3.5, 정약용, 이순신 2.8" className="w-full h-24 px-4 py-3 outline-none text-sm font-bold bg-gray-50/50 rounded-2xl focus:bg-white border border-transparent focus:border-pickle-200 transition-all resize-none" />
                                    <button onClick={addMembers} className="w-full bg-slate-900 text-white py-3.5 rounded-2xl font-black text-sm shadow-lg hover:bg-slate-800 active:scale-[0.98] transition-all">
                                        멤버 일괄 등록
                                    </button>
                                </div>
                                <div className="space-y-2">
                                    {members.map((m, idx) => (
                                        <div key={m.id} onClick={() => setDetailMember(m)} className="bg-white rounded-2xl border border-gray-100 p-4 shadow-sm group hover:border-pickle-200 transition-all relative flex items-center justify-between cursor-pointer active:scale-[0.99]">
                                            <div className="flex items-center gap-4">
                                                <div className="flex items-center justify-center bg-slate-900 text-white rounded-xl w-8 h-8 font-black text-sm group-hover:bg-pickle-600 transition-colors">
                                                    {idx + 1}
                                                </div>
                                                <div className="flex flex-col">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-base font-black text-slate-900">{m.name}</span>
                                                        <span className="text-sm font-black text-pickle-600 font-mono">{(m.rating || INITIAL_RATING).toFixed(3)}</span>
                                                    </div>
                                                    <div className="text-[10px] text-gray-400 font-bold flex items-center gap-1 mt-0.5">
                                                        <Icon name="calendar" size={10} /> 등록일: {formatDate(m.createdAt)}
                                                        <Icon name="line-chart" size={10} className="ml-1 text-emerald-400" /> <span className="text-emerald-500">Trend View</span>                                                        
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <Icon name="chevron-right" size={18} className="text-gray-300 group-hover:text-pickle-400 transition-colors" />
                                                <button onClick={(e) => {
                                                    e.stopPropagation();
                                                    openPwd(SDS_MEMBER_DEL_ONE, "@멤버 삭제", async () => {
                                                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(m.id).delete();
                                                        showToast(`${m.name} 삭제 완료!`);
                                                    });
                                                }} className="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-300 hover:text-red-500 hover:bg-red-50 transition-all">
                                                    <Icon name="trash-2" size={14}/>
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 bg-slate-50 flex justify-center border-t">
                                    <span className="text-[10px] text-slate-400 italic font-black tracking-widest">Enjoy Pickleball</span>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
